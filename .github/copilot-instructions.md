# Copilot Instructions for mizer

## Project Overview

mizer is an R package for dynamic multi-species size-spectrum modeling of fish communities. It provides a framework for modeling marine ecosystems subject to fishing, tracking individual fish growth through several orders of magnitude from egg size to maximum size, and correctly capturing ontogenetic diet shifts.

## Package Structure

This is an R package following standard CRAN conventions:

- `R/` - R source code files
- `src/` - C++ source code (Rcpp integration)
- `man/` - Documentation files (auto-generated by roxygen2)
- `tests/testthat/` - Unit tests using the testthat framework
- `vignettes/` - Long-form documentation and tutorials
- `data/` - Example datasets
- `inst/` - Additional package files
- `DESCRIPTION` - Package metadata and dependencies
- `NAMESPACE` - Package exports (auto-generated by roxygen2)

## Code Style and Conventions

### R Code Style

- **Indentation**: Use 4 spaces (not tabs)
- **Naming conventions**: 
  - Functions and variables: Use camelCase or snake_case
  - Classes: Use PascalCase (e.g., `MizerParams`, `MizerSim`)
- **Line length**: Keep lines reasonably short (no hard limit, but aim for readability)
- **No trailing whitespace**
- **Documentation**: All exported functions must have roxygen2 documentation

### Linting

The project uses `lintr` with custom configuration (see `.lintr` file):
- 4-space indentation
- Allows both camelCase and snake_case for object names
- Commented code and trailing whitespace are allowed

Run linting with:
```r
lintr::lint_package()
```

## Documentation

- Use **roxygen2** for all function documentation
- Document all parameters with `@param`
- Document return values with `@return`
- Include examples with `@examples` where appropriate
- Export functions explicitly with `@export`
- Cross-reference related functions with `@seealso`
- Use Markdown formatting in documentation (enabled in DESCRIPTION)

Example roxygen2 header:
```r
#' Brief description of the function
#'
#' Detailed description of what the function does.
#'
#' @param param1 Description of param1
#' @param param2 Description of param2
#' @return Description of what is returned
#' @export
#' @examples
#' # Example usage
#' result <- myFunction(param1, param2)
```

## Testing

- Use **testthat** (edition 3) for all tests
- Test files in `tests/testthat/` should be named `test-*.R`
- Each source file should have a corresponding test file
- Use descriptive test names with `test_that("description", { ... })`
- Use snapshot testing for complex outputs where appropriate
- Use `expect_doppelganger()` to test plots with the vdiffr package
- Run tests with `testthat::test_local()` or `devtools::test()`

Example test structure:
```r
test_that("function handles basic input correctly", {
    result <- myFunction(input)
    expect_equal(result$value, expected_value)
    expect_true(is.numeric(result$number))
})
```

## Building and Checking

### Local Development

```r
# Load package for development
devtools::load_all()

# Run tests
devtools::test()

# Check package
devtools::check()

# Build documentation
devtools::document()
```

### R CMD check

The package must pass `R CMD check` without errors or warnings:
```bash
R CMD build .
R CMD check mizer_*.tar.gz
```

## Key Classes

### MizerParams
The main parameter class containing all model configuration:
- Species parameters
- Interaction matrices
- Size bins and grids
- Rate functions
- Gear selectivity

### MizerSim
Simulation results class containing:
- Time series of size spectra
- Fishing effort history
- Model parameters used

## Important Concepts

### Size Spectrum Model
- Models track fish populations across size classes
- Individual growth is driven by consumption
- Mortality includes predation, fishing, and background mortality
- Uses allometric scaling relationships

### Rate Functions
Core physiological rates that can be customized:
- `encounter()` - predation encounter rate
- `feeding_level()` - feeding satiation
- `getPredRate()` - predation mortality rate
- `getFMort()` - fishing mortality
- `getRDI()` - reproduction (density-independent)
- `getRDD()` - reproduction (density-dependent)

## Dependencies

Key dependencies to be aware of:
- **Rcpp** - C++ integration for performance-critical code
- **deSolve** - Differential equation solver
- **ggplot2** - Plotting (version >= 3.4.0 required)
- **dplyr** - Data manipulation
- **assertthat** - Input validation

## Contributing Guidelines

Before submitting changes:
1. Ensure all tests pass: `devtools::test()`
2. Run R CMD check: `devtools::check()`
3. Update documentation: `devtools::document()`
4. Run linting: `lintr::lint_package()`
5. Update NEWS.md if adding features or fixing bugs
6. Consider adding examples to the mizerExamples package for new features

## Common Tasks

### Adding a new function
1. Create the function in the appropriate R file
2. Add roxygen2 documentation
3. Export if needed with `@export`
4. Add unit tests in corresponding test file
5. Run `devtools::document()` to update NAMESPACE and man pages
6. Run `devtools::check()` to verify

### Modifying existing functions
1. Update the function code
2. Update roxygen2 documentation if needed
3. Ensure existing tests still pass or update them
4. Add new tests for new behavior
5. Consider backward compatibility

### Working with Rcpp code
- C++ source files are in `src/`
- Use `Rcpp::sourceCpp()` for quick testing
- RcppExports.R and RcppExports.cpp are auto-generated
- Rebuild package after C++ changes: `devtools::clean_dll(); devtools::load_all()`

## References

- Package website: https://sizespectrum.org/mizer/
- GitHub repository: https://github.com/sizespectrum/mizer
- Issue tracker: https://github.com/sizespectrum/mizer/issues
- Theoretical foundation: "Fish Ecology, Evolution, and Exploitation" by Ken Andersen

## Related Packages

- **mizerExperimental** - Experimental features and community contributions
- **mizerExamples** - Example models and use cases

## Note on British English

The package uses British English spelling (en-GB) as specified in DESCRIPTION. Use British spellings in documentation and comments (e.g., "colour" not "color", "behaviour" not "behavior").
